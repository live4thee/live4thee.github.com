<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
		
		<meta name="generator" content="Hugo 0.68.3" />
		<title>MySQL/Mariadb Notes - 1 &middot; Life as a Programmer</title>
		<link rel="shortcut icon" href="https://live4thee.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://live4thee.github.io/css/style.css">
		<link rel="stylesheet" href="https://live4thee.github.io/css/highlight.css">

		
		<link rel="stylesheet" href="https://live4thee.github.io/css/font-awesome.min.css">
		

		
		<link href="https://live4thee.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Life as a Programmer" />
		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://live4thee.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://live4thee.github.io/posts'>Archive</a>
	<a href='https://live4thee.github.io/tags'>Tags</a>
	<a href='https://live4thee.github.io/about'>About</a>

	

	
	<a class="cta" href="https://live4thee.github.io/index.xml">Subscribe</a>
	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        MySQL/Mariadb Notes - 1
                    </h1>
                    <h2 class="headline">
                    Mar 28, 2020 14:31
                    · 708 words
                    · 2 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://live4thee.github.io/tags/sysadmin">sysadmin</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<h2 id="mysql-8">MySQL 8</h2>

<p>跑部署脚本的时候，一直报错：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds
to your MySQL server version for the right syntax to use near &#39;IDENTIFIED BY &#39;secret&#39; at
line 1</code></pre></div>
<p>啥，语法错？看了一下执行的 SQL 语句，很正常的样子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> dbname.<span style="color:#f92672">*</span> <span style="color:#66d9ef">to</span> <span style="color:#e6db74">&#39;user&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#34;secret&#34;</span>;</code></pre></div>
<p>把 IDENTIFIED 那段删掉，果然就可以了。搜了一下，原来前几天 apt-get 升
级的时候，本机的 MySQL 升级到了 MySQL 8 版本。现在 GRANT 权限之前，必
须先创建用户。也就是写成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> <span style="color:#e6db74">&#39;user&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;% IDENTIFIED BY &#39;</span>secret<span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">GRANT ALL ON dbname.* TO &#39;</span><span style="color:#66d9ef">user</span><span style="color:#e6db74">&#39;@&#39;</span><span style="color:#f92672">%</span><span style="color:#e6db74">&#39;;</span></code></pre></div>
<p>c.f. <a href="https://ma.ttias.be/mysql-8-removes-shorthand-creating-user-permissions/">MySQL 8 removes shorthand for creating user + permissions</a></p>

<h2 id="flyway">flyway</h2>

<p>另外一个 CentOS 环境把 Mariadb 5.5 升级到了 10.3, 跑 flyway 的时候发现
几句 SQL 的写法在新版本已经不合法了。必须改 SQL。但改掉后会改变文件的
哈希值，导致升级时跑 flyway 报错。</p>

<h3 id="beforemigrate">beforeMigrate</h3>

<p>第一个尝试是在 flyway 的 beforeMigrate <a href="https://flywaydb.org/documentation/callbacks.html">callbacks</a> 里面先
把 <em>schema_version</em> 里的哈希值改掉。某个帖子看到：beforeMigrate 执行
的时候，<em>schema_version</em> 表还没锁。有戏。</p>

<p>兴冲冲写了个 beforeMigrate, 然后 flyway 一个大耳光：哈希错。加上 &lsquo;-X&rsquo; 打印调试信息，原来是 valiation 阶段就报错了，还没跑到 migrate 阶
段。不慌，之前的 <a href="https://flywaydb.org/documentation/callbacks.html">callbacks</a> 里面有个 beforeValidate&hellip;</p>

<h3 id="beforevalidate">beforeValidate</h3>

<p>beforeValidate 确实打开了新世界的大门。把之前写在 beforeMigrate 的代码
移过去后，验证了一下老版本升级，美美美。沉醉在代码里不可自拔。</p>

<p>恢复环境，回退到老版本，未果。安装脚本报 repo 版本不对。删掉安装目录，
DROP 数据库再次安装，居然报错了！beforeValidate 脚本报错！我美妙的
检查：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span>(<span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">table_name</span> <span style="color:#66d9ef">FROM</span> information_schema.tables <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">table_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;schema_version&#39;</span>)
<span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span>(<span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">schema_name</span> <span style="color:#66d9ef">FROM</span> information_schema.schemata <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">schema_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dbname)</span></code></pre></div>
<p>居然统统没管用！但是，单独执行 <code>mysql ... &lt; beforeValidate.sql</code> 又工作的很好。
神奇。</p>

<h3 id="beforevalidate-again">beforeValidate again!</h3>

<p>搜到这样<a href="https://oipapio.com/question-9217299">一段描述</a>：</p>

<p><img src="/media/flyway.png" alt="flyway" /></p>

<p>这个 &ldquo;one caveat&rdquo; 仿佛黑暗中一道闪光。flyway 的官网扒了一下 callbacks，
只有简要的描述，没有示例，这对于 error handling 相关的使用毫无用处。最
后 Frank 同学提示可以试试 flyway 的 <code>baseline</code> 命令。几番魔改，得到这
样一个稳定工作的时序：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flyway clean <span style="color:#75715e"># clean environment</span>
flyway baseline
mysql ... <span style="color:#e6db74">&#39;DELETE FROM schema_version&#39;</span>
flyway migrate</code></pre></div>
<p>回头再看，beforeValidate 里的 &lsquo;IF EXISTS&rsquo; 既无用也多余。</p>

                </section>
            </article>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'live4thee'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            

            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://www.facebook.com/live4thee">
        <i class="fa fa-facebook-square"></i>
    </a>
    
    <a class="symbol" href="https://github.com/live4thee">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://twitter.com/live4thee">
        <i class="fa fa-twitter-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2021 <i class="fa fa-heart" aria-hidden="true"></i> 
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="https://live4thee.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://live4thee.github.io/js/main.js"></script>
<script src="https://live4thee.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







    </body>
</html>
