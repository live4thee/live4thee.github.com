<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
		
		<meta name="generator" content="Hugo 0.68.3" />
		<title>Interpreting Linux OOM Logs (1/2) &middot; Life as a Programmer</title>
		<link rel="shortcut icon" href="https://live4thee.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://live4thee.github.io/css/style.css">
		<link rel="stylesheet" href="https://live4thee.github.io/css/highlight.css">

		
		<link rel="stylesheet" href="https://live4thee.github.io/css/font-awesome.min.css">
		

		
		<link href="https://live4thee.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Life as a Programmer" />
		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://live4thee.github.io/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://live4thee.github.io/posts'>Archive</a>
	<a href='https://live4thee.github.io/tags'>Tags</a>
	<a href='https://live4thee.github.io/about'>About</a>

	

	
	<a class="cta" href="https://live4thee.github.io/index.xml">Subscribe</a>
	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        Interpreting Linux OOM Logs (1/2)
                    </h1>
                    <h2 class="headline">
                    Apr 12, 2019 10:28
                    · 1038 words
                    · 3 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://live4thee.github.io/tags/mm">mm</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<p>本文描述如何分析 Linux OOM 日志。下面的日志去掉了开头的时间戳。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">HOST1 kernel: prometheus invoked oom-killer: gfp_mask=0x0, order=0, oom_score_adj=0
HOST1 kernel: prometheus cpuset=docker-f55e8d749684a0746aa1cb3d186df370848ba502cc19d249bf732450de5a2f30.scope mems_allowed=0-3
HOST1 kernel: CPU: 88 PID: 49521 Comm: prometheus Tainted: G           OE  ------------   3.10.0-327.36.1.el7.x86_64 #1
HOST1 kernel: Hardware name: Dell Inc. PowerEdge R930/0Y0V4F, BIOS 2.4.3 07/07/2017
HOST1 kernel: ffff88bf0612f300 00000000cbfaa699 ffff88ff0e857ce0 ffffffff81636301
HOST1 kernel: ffff88ff0e857d70 ffffffff8163129c 0000000000000297 ffff88ff0e857db0
HOST1 kernel: 0000000000000001 00000000fc107000 0000000000000001 0000000000000010
HOST1 kernel: Call Trace:
HOST1 kernel: [&lt;ffffffff81636301&gt;] dump_stack+0x19/0x1b
HOST1 kernel: [&lt;ffffffff8163129c&gt;] dump_header+0x8e/0x214
HOST1 kernel: [&lt;ffffffff8116d21e&gt;] oom_kill_process+0x24e/0x3b0
HOST1 kernel: [&lt;ffffffff8116cd86&gt;] ? find_lock_task_mm+0x56/0xc0
HOST1 kernel: [&lt;ffffffff8116da46&gt;] out_of_memory+0x4b6/0x4f0
HOST1 kernel: [&lt;ffffffff8116daf1&gt;] pagefault_out_of_memory+0x71/0x90
HOST1 kernel: [&lt;ffffffff8162f6e5&gt;] mm_fault_error+0x68/0x12b
HOST1 kernel: [&lt;ffffffff81642192&gt;] __do_page_fault+0x3e2/0x450
HOST1 kernel: [&lt;ffffffff81642223&gt;] do_page_fault+0x23/0x80
HOST1 kernel: [&lt;ffffffff8163e508&gt;] page_fault+0x28/0x30</code></pre></div>
<p>第一行表明 OOM 发生在 prometheus 申请内存失败，触发了 oom-killer。后面
有三个值：<em>gfp_mask</em>, <em>order</em> 以及 <em>oom_score_adj</em>.</p>

<h2 id="gfp-mask-order-and-oom-score-adj"><em>gfp_mask</em>, <em>order</em> and <em>oom_score_adj</em></h2>

<h3 id="gfp-mask"><em>gfp_mask</em></h3>

<p>代表申请内存时候的参数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// c.f. include/linux/gfp.h
</span><span style="color:#75715e"></span><span style="color:#75715e">/* Plain integer GFP bitmasks. Do not use this directly. */</span>
<span style="color:#75715e">#define ___GFP_DMA              0x01u
</span><span style="color:#75715e">#define ___GFP_HIGHMEM          0x02u
</span><span style="color:#75715e">#define ___GFP_DMA32            0x04u
</span><span style="color:#75715e">#define ___GFP_MOVABLE          0x08u
</span><span style="color:#75715e">#define ___GFP_RECLAIMABLE      0x10u
</span><span style="color:#75715e">#define ___GFP_HIGH             0x20u
</span><span style="color:#75715e"></span>...</code></pre></div>
<h3 id="order"><em>order</em></h3>

<p>如果是 -1 的话，代表 OOM 是通过
<a href="https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html">SysRq</a>
触发。</p>

<p>这里是 0，我们得到 2 ^^ 0 = 1，也就是请求分配 1 页（或者更多）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// c.f. include/linux/oom.h
</span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span><span style="color:#75715e"> * order == -1 means the oom kill is required by sysrq, otherwise only
</span><span style="color:#75715e"> * for display purposes.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> order;</code></pre></div>
<h3 id="oom-score-adj"><em>oom_score_adj</em></h3>

<p>代表进程的 badness score 的调整值。</p>

<p>OOM killer 选择被杀进程时，会把这个调整值加到进程的 badness score 上作
为最终的分值。这个调整值的取值范围是 -1000 (<em>OOM_SCORE_ADJ_MIN</em>) 到
1000 (<em>OOM_SCORE_ADJ_MAX</em>)。进程的 badness 分值越高越容易被杀死。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cat /proc/$$/oom_score
<span style="color:#ae81ff">0</span>
$ cat /proc/$$/oom_score_adj
<span style="color:#ae81ff">0</span></code></pre></div>
<p>此外，我们还看到了进程对应的 CPU 编号，进程号，内核版本以及硬件描述等
信息。</p>

<h2 id="内存信息">内存信息</h2>

<p>OOM killer 杀掉进程（如下，19434）之前，会打印出系统的进程信息。其中，
内存占用是以页（默认 4 kB）为单位的，比如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">HOST1 kernel: [ 2535]     0  2535    29188 ...</code></pre></div>
<p>这里的 29188 是指 29188 * 4 kB.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">HOST1 kernel: Mem-Info:                                                                                                                                                                     HOST1 kernel: Node 0 DMA per-cpu:
HOST1 kernel: CPU    0: hi:    0, btch:   1 usd:   0
HOST1 kernel: CPU    1: hi:    0, btch:   1 usd:   0
HOST1 kernel: CPU    2: hi:    0, btch:   1 usd:   0
HOST1 kernel: CPU    3: hi:    0, btch:   1 usd:   0
...
HOST1 kernel: active_anon:136788940 inactive_anon:627992 isolated_anon:0#012
 active_file:6127082 inactive_file:8045807 isolated_file:0#012
 unevictable:1832 dirty:187 writeback:16 unstable: 0#012
 free:104942660 slab_reclaimable:4803157 slab_unreclaimable:257603#012
 mapped:1804194 shmem:1395209 pagetables:297437 bounce:0#012
 free_cma:0
...
HOST1 kernel: 15569613 total pagecache pages
HOST1 kernel: 0 pages in swap cache
HOST1 kernel: Swap cache stats: add 0, delete 0, find 0/1
HOST1 kernel: Free swap  = 4194300kB
HOST1 kernel: Total swap = 4194300kB
HOST1 kernel: 268408898 pages RAM
HOST1 kernel: 0 pages HighMem/MovableOnly
HOST1 kernel: 4261955 pages reserved
HOST1 kernel: [ pid ]   uid  tgid total_vm      rss nr_ptes swapents oom_score_adj name
HOST1 kernel: [ 1922]     0  1922    45185    26567      90        0             0 systemd-journal
HOST1 kernel: [ 1950]     0  1950    10973      461      21        0         -1000 systemd-udevd
HOST1 kernel: [ 2579]    81  2579     6686      479      17        0          -900 dbus-daemon
HOST1 kernel: [ 2604]     0  2604     4952      458      13        0             0 irqbalance
HOST1 kernel: [ 3359]     0  3359    20641      898      42        0         -1000 sshd
HOST1 kernel: [19434]     0 19434  8729888  8434255   16732        0             0 xxxx
...
HOST1 kernel: Out of memory: Kill process 19434 (xxxx) score 31 or sacrifice child                                                                                                      HOST1 kernel: Killed process 19434 (xxxx) total-vm:34919552kB, anon-rss:33698680kB, file-rss:38340kB</code></pre></div>
<h3 id="pid-and-tgid"><em>pid</em> and <em>tgid</em></h3>

<p>pid 是指 process id，而 tgid 是指 thread group id。这个涉及到 Linux 的
线程模型和调度模型。下面一张
<a href="https://stackoverflow.com/questions/9305992">图</a>很好的解释了两者的关
系。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">                      USER VIEW
 &lt;-- PID 43 --&gt; &lt;----------------- PID 42 -----------------&gt;
                     +---------+
                     | process |
                    _| pid=42  |_
                  _/ | tgid=42 | \_ (new thread) _
       _ (fork) _/   +---------+                  \
      /                                        +---------+
+---------+                                    | process |
| process |                                    | pid=44  |
| pid=43  |                                    | tgid=42 |
| tgid=43 |                                    +---------+
+---------+
 &lt;-- PID 43 --&gt; &lt;--------- PID 42 --------&gt; &lt;--- PID 44 ---&gt;
                     KERNEL VIEW</code></pre></div>
<h3 id="total-vm-and-rss"><em>total_vm</em> and <em>rss</em></h3>

<p><em>total_vm</em> 即进程已经申请的虚拟内存总大小。<em>rss</em> 是驻留在内存页数。</p>

<p>这里我们看到进程 19434 被杀掉了。被杀掉前，它占用的虚拟内存是
8729888 * 4 kB，34 GB 多一点。占用的物理内存是 8434255 * 4 kB，差不多
33 GB。OOM 之前，系统总的页数：268408898，可用页数：104942660，占比
39.1%。</p>

<p>那么问题来了，为啥会发生 OOM 呢？毕竟 free 还剩下将近 40%.</p>

                </section>
            </article>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'live4thee'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            

            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://www.facebook.com/live4thee">
        <i class="fa fa-facebook-square"></i>
    </a>
    
    <a class="symbol" href="https://github.com/live4thee">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://twitter.com/live4thee">
        <i class="fa fa-twitter-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2021 <i class="fa fa-heart" aria-hidden="true"></i> 
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="https://live4thee.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://live4thee.github.io/js/main.js"></script>
<script src="https://live4thee.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







    </body>
</html>
